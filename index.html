<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LSTMç½‘ç»œæµé‡é¢„è­¦ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e293b 0%, #581c87 50%, #1e293b 100%);
            min-height: 100vh; color: #333; padding: 16px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        
        /* å¤´éƒ¨ */
        .header {
            background: rgba(255,255,255,0.1); backdrop-filter: blur(10px);
            border-radius: 12px; padding: 16px 24px; margin-bottom: 16px;
            display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;
        }
        .header-title { color: white; }
        .header-title h1 { font-size: 1.5em; display: flex; align-items: center; gap: 8px; }
        .header-title p { font-size: 0.85em; color: #cbd5e1; margin-top: 4px; }
        .header-controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .header-controls select, .header-controls button {
            padding: 8px 16px; border-radius: 8px; font-size: 0.9em; cursor: pointer; border: none;
        }
        .header-controls select { background: rgba(255,255,255,0.2); color: white; }
        .header-controls select option { color: #333; }
        .btn-start { background: #22c55e; color: white; }
        .btn-stop { background: #ef4444; color: white; }
        .btn-report { background: #3b82f6; color: white; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        
        /* ç»Ÿè®¡å¡ç‰‡ */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 16px; }
        @media (max-width: 900px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 500px) { .stats-grid { grid-template-columns: 1fr; } }
        .stat-card {
            background: white; border-radius: 12px; padding: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 4px solid #3b82f6; display: flex; justify-content: space-between; align-items: center;
        }
        .stat-card.green { border-left-color: #22c55e; }
        .stat-card.purple { border-left-color: #8b5cf6; }
        .stat-card.orange { border-left-color: #f59e0b; }
        .stat-card.red { border-left-color: #ef4444; }
        .stat-info h3 { font-size: 0.85em; color: #6b7280; font-weight: 500; }
        .stat-info .value { font-size: 1.8em; font-weight: bold; color: #1f2937; }
        .stat-info .unit { font-size: 0.7em; color: #9ca3af; }
        .stat-icon { width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5em; }
        .stat-icon.blue { background: #dbeafe; }
        .stat-icon.green { background: #dcfce7; }
        .stat-icon.purple { background: #f3e8ff; }
        .stat-icon.orange { background: #fef3c7; }
        
        /* ä¸»å†…å®¹åŒº */
        .main-content { display: grid; grid-template-columns: 2fr 1fr; gap: 16px; margin-bottom: 16px; }
        @media (max-width: 1000px) { .main-content { grid-template-columns: 1fr; } }
        
        .chart-panel, .alert-panel {
            background: white; border-radius: 12px; padding: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .panel-title { font-size: 1em; font-weight: 600; color: #374151; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .chart-wrapper { position: relative; height: 280px; }
        
        /* è­¦æŠ¥é¢æ¿ */
        .alert-list { max-height: 300px; overflow-y: auto; }
        .alert-item {
            padding: 12px; margin-bottom: 8px; border-radius: 8px; border-left: 4px solid;
            font-size: 0.85em; animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        .alert-high { background: #fef2f2; border-left-color: #dc2626; color: #7f1d1d; }
        .alert-medium { background: #fff7ed; border-left-color: #ea580c; color: #7c2d12; }
        .alert-low { background: #fefce8; border-left-color: #ca8a04; color: #713f12; }
        .alert-item strong { display: block; margin-bottom: 4px; }
        .alert-item small { color: #6b7280; }
        .no-alert { text-align: center; padding: 40px; color: #9ca3af; }
        .no-alert .icon { font-size: 3em; margin-bottom: 8px; }
        
        /* æ®‹å·®å›¾ */
        .residual-panel { background: white; border-radius: 12px; padding: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 16px; }
        .residual-chart { height: 180px; }
        
        /* åº•éƒ¨çŠ¶æ€æ  */
        .status-bar {
            background: rgba(255,255,255,0.1); backdrop-filter: blur(10px);
            border-radius: 12px; padding: 12px 20px; display: flex; justify-content: space-between;
            align-items: center; color: white; font-size: 0.85em; flex-wrap: wrap; gap: 8px;
        }
        .status-indicator { display: flex; align-items: center; gap: 8px; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; }
        .status-dot.running { background: #22c55e; animation: pulse 1.5s infinite; }
        .status-dot.stopped { background: #6b7280; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .status-info { display: flex; gap: 20px; color: #cbd5e1; }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <div class="header-title">
                <h1>ğŸ›¡ï¸ LSTMç½‘ç»œæµé‡é¢„è­¦ç³»ç»Ÿ</h1>
                <p>åŸºäºæ·±åº¦å­¦ä¹ çš„å®æ—¶æµé‡å¼‚å¸¸æ£€æµ‹ (NF01æ¨¡å‹)</p>
            </div>
            <div class="header-controls">
                <label style="color:white;">é˜ˆå€¼:</label>
                <select id="thresholdSelect">
                    <option value="2">2Ïƒ</option>
                    <option value="2.5" selected>2.5Ïƒ</option>
                    <option value="3">3Ïƒ</option>
                </select>
                <button class="btn-start" onclick="startMonitoring()">â–¶ å¼€å§‹ç›‘æ§</button>
                <button class="btn-stop" onclick="stopMonitoring()">â¸ æš‚åœ</button>
                <button class="btn-report" onclick="downloadReport()">ğŸ“¥ å¯¼å‡ºæŠ¥å‘Š</button>
            </div>
        </div>

        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-info">
                    <h3>å®é™…æµé‡å‡å€¼</h3>
                    <div class="value"><span id="avgActual">0</span><span class="unit"> flows</span></div>
                </div>
                <div class="stat-icon blue">ğŸ“Š</div>
            </div>
            <div class="stat-card green">
                <div class="stat-info">
                    <h3>é¢„æµ‹æµé‡å‡å€¼</h3>
                    <div class="value"><span id="avgPredicted">0</span><span class="unit"> flows</span></div>
                </div>
                <div class="stat-icon green">ğŸ“ˆ</div>
            </div>
            <div class="stat-card purple">
                <div class="stat-info">
                    <h3>é¢„æµ‹å‡†ç¡®ç‡</h3>
                    <div class="value"><span id="accuracy">0</span><span class="unit"> %</span></div>
                </div>
                <div class="stat-icon purple">ğŸ¯</div>
            </div>
            <div class="stat-card orange" id="anomalyCard">
                <div class="stat-info">
                    <h3>å¼‚å¸¸æ£€æµ‹æ•°</h3>
                    <div class="value"><span id="anomalyCount">0</span><span class="unit"> æ¬¡</span></div>
                </div>
                <div class="stat-icon orange">âš ï¸</div>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content">
            <div class="chart-panel">
                <div class="panel-title">ğŸ“ˆ å®æ—¶æµé‡ç›‘æ§ & LSTMé¢„æµ‹</div>
                <div class="chart-wrapper"><canvas id="trafficChart"></canvas></div>
            </div>
            <div class="alert-panel">
                <div class="panel-title">ğŸš¨ å¼‚å¸¸è­¦æŠ¥ (<span id="alertCount">0</span>)</div>
                <div class="alert-list" id="alertList">
                    <div class="no-alert"><div class="icon">ğŸ›¡ï¸</div><p>ç³»ç»Ÿè¿è¡Œæ­£å¸¸</p><small>æš‚æ— å¼‚å¸¸è­¦æŠ¥</small></div>
                </div>
            </div>
        </div>

        <!-- æ®‹å·®å›¾ -->
        <div class="residual-panel">
            <div class="panel-title">ğŸ“‰ é¢„æµ‹æ®‹å·®åˆ†æ</div>
            <div class="residual-chart"><canvas id="residualChart"></canvas></div>
        </div>

        <!-- åº•éƒ¨çŠ¶æ€æ  -->
        <div class="status-bar">
            <div class="status-indicator">
                <span class="status-dot stopped" id="statusDot"></span>
                <span id="statusText">æœªå¯åŠ¨</span>
            </div>
            <div class="status-info">
                <span>æ¨¡å‹: LSTM (NF01)</span>
                <span>çª—å£: 60æ­¥</span>
                <span>æ›´æ–°: 2ç§’</span>
                <span>æ•°æ®ç‚¹: <span id="dataCount">0</span></span>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let trafficChart, residualChart;
        let monitoringInterval = null;
        let trafficData = [], alerts = [];
        const MAX_POINTS = 60;
        const API_BASE = 'http://localhost:5000';

        // åˆå§‹åŒ–å›¾è¡¨
        function initCharts() {
            const ctxTraffic = document.getElementById('trafficChart').getContext('2d');
            trafficChart = new Chart(ctxTraffic, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        { label: 'å®é™…æµé‡', data: [], borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.1)', borderWidth: 2, fill: true, tension: 0.3, pointRadius: 0 },
                        { label: 'LSTMé¢„æµ‹', data: [], borderColor: '#22c55e', borderWidth: 2, borderDash: [5,5], tension: 0.3, pointRadius: 0, fill: false },
                        { label: 'ä¸Šç•Œ', data: [], borderColor: '#fbbf24', backgroundColor: 'rgba(251,191,36,0.15)', borderWidth: 1, fill: '+1', tension: 0.3, pointRadius: 0 },
                        { label: 'ä¸‹ç•Œ', data: [], borderColor: '#fbbf24', borderWidth: 1, fill: false, tension: 0.3, pointRadius: 0 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: { grid: { color: 'rgba(0,0,0,0.05)' } },
                        y: { beginAtZero: false, grid: { color: 'rgba(0,0,0,0.05)' }, title: { display: true, text: 'æµé‡ (flows)' } }
                    },
                    plugins: { legend: { position: 'top', labels: { usePointStyle: true, padding: 15 } } },
                    animation: { duration: 0 }
                }
            });

            const ctxResidual = document.getElementById('residualChart').getContext('2d');
            residualChart = new Chart(ctxResidual, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{ label: 'æ®‹å·®', data: [], borderColor: '#8b5cf6', backgroundColor: 'rgba(139,92,246,0.1)', borderWidth: 2, fill: true, tension: 0.3, pointRadius: 0 }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { grid: { color: 'rgba(0,0,0,0.05)' } },
                        y: { grid: { color: 'rgba(0,0,0,0.05)' }, title: { display: true, text: 'æ®‹å·®' } }
                    },
                    plugins: {
                        legend: { display: false },
                        annotation: { annotations: {} }
                    },
                    animation: { duration: 0 }
                }
            });
        }

        // ä»APIè·å–æ•°æ®
        async function fetchData() {
            try {
                const response = await fetch(`${API_BASE}/api/current_data`);
                if (!response.ok) throw new Error('APIè¯·æ±‚å¤±è´¥');
                return await response.json();
            } catch (error) {
                console.error('è·å–æ•°æ®å¤±è´¥:', error);
                return null;
            }
        }

        // æ›´æ–°å›¾è¡¨æ•°æ®
        function updateCharts(data) {
            if (!data) return;
            
            const timestamp = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const threshold = parseFloat(document.getElementById('thresholdSelect').value);
            const std = 80; // æ ‡å‡†å·®ä¼°è®¡å€¼
            const thresholdValue = threshold * std;

            // æ„é€ æ•°æ®ç‚¹
            const point = {
                timestamp,
                actual: data.total_kb || Math.random() * 500 + 800,
                predicted: (data.predictions && data.predictions[0]) || (data.total_kb * 0.95 + Math.random() * 50),
                residual: 0,
                upperBound: 0,
                lowerBound: 0,
                isAnomaly: data.is_anomaly || false
            };
            point.residual = point.actual - point.predicted;
            point.upperBound = point.predicted + thresholdValue;
            point.lowerBound = Math.max(0, point.predicted - thresholdValue);
            point.isAnomaly = Math.abs(point.residual) > thresholdValue;

            trafficData.push(point);
            if (trafficData.length > MAX_POINTS) trafficData.shift();

            // æ›´æ–°æµé‡å›¾
            trafficChart.data.labels = trafficData.map(d => d.timestamp);
            trafficChart.data.datasets[0].data = trafficData.map(d => d.actual.toFixed(2));
            trafficChart.data.datasets[1].data = trafficData.map(d => d.predicted.toFixed(2));
            trafficChart.data.datasets[2].data = trafficData.map(d => d.upperBound.toFixed(2));
            trafficChart.data.datasets[3].data = trafficData.map(d => d.lowerBound.toFixed(2));
            trafficChart.update('none');

            // æ›´æ–°æ®‹å·®å›¾
            residualChart.data.labels = trafficData.map(d => d.timestamp);
            residualChart.data.datasets[0].data = trafficData.map(d => d.residual.toFixed(2));
            residualChart.data.datasets[0].pointBackgroundColor = trafficData.map(d => d.isAnomaly ? '#ef4444' : 'transparent');
            residualChart.data.datasets[0].pointRadius = trafficData.map(d => d.isAnomaly ? 5 : 0);
            residualChart.update('none');

            // æ£€æµ‹å¼‚å¸¸å¹¶æ·»åŠ è­¦æŠ¥
            if (point.isAnomaly) {
                addAlert(point, thresholdValue);
            }

            // æ›´æ–°ç»Ÿè®¡
            updateStats();
        }

        // æ·»åŠ è­¦æŠ¥
        function addAlert(point, threshold) {
            const severity = Math.abs(point.residual) > threshold * 1.5 ? 'high' : Math.abs(point.residual) > threshold ? 'medium' : 'low';
            const alert = { id: Date.now(), ...point, severity, threshold: threshold.toFixed(0) };
            alerts.unshift(alert);
            if (alerts.length > 10) alerts.pop();

            const alertList = document.getElementById('alertList');
            const severityText = { high: 'é«˜å±', medium: 'ä¸­å±', low: 'ä½å±' };
            const alertClass = `alert-${severity}`;

            if (alerts.length === 1) alertList.innerHTML = '';

            const alertHTML = `
                <div class="alert-item ${alertClass}">
                    <strong>âš ï¸ ${severityText[severity]}å¼‚å¸¸</strong>
                    æ—¶é—´: ${point.timestamp} | æµé‡: ${point.actual.toFixed(2)}<br>
                    <small>æ®‹å·®: ${point.residual.toFixed(2)} | é˜ˆå€¼: Â±${alert.threshold}</small>
                </div>
            `;
            alertList.insertAdjacentHTML('afterbegin', alertHTML);
            
            // ä¿æŒæœ€å¤š10æ¡
            while (alertList.children.length > 10) {
                alertList.removeChild(alertList.lastChild);
            }

            document.getElementById('alertCount').textContent = alerts.length;
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            if (trafficData.length === 0) return;

            const avgActual = trafficData.reduce((s, d) => s + d.actual, 0) / trafficData.length;
            const avgPredicted = trafficData.reduce((s, d) => s + d.predicted, 0) / trafficData.length;
            const mape = trafficData.reduce((s, d) => s + Math.abs((d.actual - d.predicted) / (d.actual || 1)), 0) / trafficData.length * 100;
            const anomalyCount = trafficData.filter(d => d.isAnomaly).length;

            document.getElementById('avgActual').textContent = avgActual.toFixed(0);
            document.getElementById('avgPredicted').textContent = avgPredicted.toFixed(0);
            document.getElementById('accuracy').textContent = Math.max(0, 100 - mape).toFixed(1);
            document.getElementById('anomalyCount').textContent = anomalyCount;
            document.getElementById('dataCount').textContent = trafficData.length;

            // å¼‚å¸¸æ•°é«˜æ—¶å˜çº¢
            const card = document.getElementById('anomalyCard');
            card.className = anomalyCount > 5 ? 'stat-card red' : 'stat-card orange';
        }

        // å¼€å§‹ç›‘æ§
        function startMonitoring() {
            if (monitoringInterval) return;

            document.getElementById('statusDot').className = 'status-dot running';
            document.getElementById('statusText').textContent = 'ç›‘æ§è¿è¡Œä¸­';

            // ç«‹å³è·å–ä¸€æ¬¡æ•°æ®
            fetchData().then(updateCharts);

            monitoringInterval = setInterval(async () => {
                const data = await fetchData();
                updateCharts(data);
            }, 2000);
        }

        // åœæ­¢ç›‘æ§
        function stopMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
            }
            document.getElementById('statusDot').className = 'status-dot stopped';
            document.getElementById('statusText').textContent = 'å·²æš‚åœ';
        }

        // å¯¼å‡ºæŠ¥å‘Š
        function downloadReport() {
            const stats = {
                avgActual: document.getElementById('avgActual').textContent,
                avgPredicted: document.getElementById('avgPredicted').textContent,
                accuracy: document.getElementById('accuracy').textContent,
                anomalyCount: document.getElementById('anomalyCount').textContent
            };

            const report = `
=====================================
    LSTMç½‘ç»œæµé‡é¢„è­¦ç³»ç»Ÿ - ç›‘æ§æŠ¥å‘Š
=====================================

ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString()}
ç›‘æ§æ¨¡å‹: NF01 LSTM

ã€ç»Ÿè®¡æ¦‚è§ˆã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â€¢ å®é™…æµé‡å‡å€¼: ${stats.avgActual} flows
â€¢ é¢„æµ‹æµé‡å‡å€¼: ${stats.avgPredicted} flows
â€¢ é¢„æµ‹å‡†ç¡®ç‡:   ${stats.accuracy}%
â€¢ å¼‚å¸¸æ£€æµ‹æ•°:   ${stats.anomalyCount} æ¬¡
â€¢ æ•°æ®ç‚¹æ€»æ•°:   ${trafficData.length}

ã€å¼‚å¸¸é˜ˆå€¼é…ç½®ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â€¢ Sigmaå€æ•°: ${document.getElementById('thresholdSelect').value}Ïƒ

ã€æœ€è¿‘å¼‚å¸¸è®°å½•ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
${alerts.slice(0, 5).map(a => `[${a.timestamp}] æµé‡:${a.actual.toFixed(2)} æ®‹å·®:${a.residual.toFixed(2)}`).join('\n') || 'æ— å¼‚å¸¸è®°å½•'}

=====================================
        æŠ¥å‘Šç”Ÿæˆå®Œæ¯•
=====================================
            `.trim();

            const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `æµé‡ç›‘æ§æŠ¥å‘Š_${new Date().toISOString().slice(0, 10)}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
            // è‡ªåŠ¨å¼€å§‹ç›‘æ§
            setTimeout(startMonitoring, 500);
        });
    </script>
</body>
</html>